name: Release Build

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  # Windows æ‰“åŒ…
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Release
        run: cargo build --release -p view

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create ZIP package
        shell: pwsh
        run: |
          $VERSION = "${{ steps.get_version.outputs.VERSION }}"
          .\package.ps1 -Version $VERSION

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Download Inno Setup Translations
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/Unofficial/ChineseSimplified.isl" -OutFile "ChineseSimplified.isl"

      - name: Create installer
        shell: pwsh
        run: |
          $VERSION = "${{ steps.get_version.outputs.VERSION }}"
          # ç­‰å¾… Inno Setup å®‰è£…å®Œæˆ
          Start-Sleep -Seconds 10
          $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
          .\build-installer.ps1 -Version $VERSION -InnoSetupPath "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: release-package/*.zip

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer-output/*.exe

  # macOS æ‰“åŒ…
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build and Package
        run: |
          chmod +x package-macos.sh
          ./package-macos.sh ${{ steps.get_version.outputs.VERSION }}

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: release-package/*.dmg
        continue-on-error: true

      - name: Upload macOS tar.gz
        uses: actions/upload-artifact@v4
        with:
          name: macos-tarball
          path: release-package/*-macos.tar.gz

  # Linux æ‰“åŒ…
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            lld \
            clang \
            pkg-config \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxkbcommon-x11-dev \
            libxcb-xkb-dev \
            libwayland-dev \
            libvulkan-dev \
            libx11-dev \
            libegl1-mesa-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            dpkg-dev \
            rpm \
            libgtk-3-dev \
            libfuse2

      - name: Install AppImage tools
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build and Package
        env:
          APPIMAGE_EXTRACT_AND_RUN: 1
        run: |
          chmod +x package-linux.sh
          ./package-linux.sh ${{ steps.get_version.outputs.VERSION }}

      - name: Upload Linux DEB
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: release-package/*.deb
        continue-on-error: true

      - name: Upload Linux RPM
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: release-package/*.rpm
        continue-on-error: true

      - name: Upload Linux tar.gz
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: release-package/*-linux-*.tar.gz

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: release-package/*.AppImage
        continue-on-error: true

  # åˆ›å»º GitHub Release
  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: CANVIEW v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## CANVIEW v${{ steps.get_version.outputs.VERSION }}

            ### ğŸš€ ä¸‹è½½

            #### Windows
            - **å®‰è£…ç¨‹åº**: `CANVIEW-Setup-v${{ steps.get_version.outputs.VERSION }}.exe` - æ¨è
            - **ä¾¿æºç‰ˆ**: `CANVIEW-v${{ steps.get_version.outputs.VERSION }}.zip`

            #### macOS
            - **DMG é•œåƒ**: `CANVIEW-v${{ steps.get_version.outputs.VERSION }}.dmg`
            - **å‹ç¼©åŒ…**: `CANVIEW-v${{ steps.get_version.outputs.VERSION }}-macos.tar.gz`

            #### Linux
            - **AppImage**: `canview-v${{ steps.get_version.outputs.VERSION }}-x86_64.AppImage` - æ¨è
            - **Debian/Ubuntu**: `canview_${{ steps.get_version.outputs.VERSION }}_amd64.deb`
            - **Fedora/RHEL**: `canview-${{ steps.get_version.outputs.VERSION }}-1.*.rpm`
            - **é€šç”¨åŒ…**: `canview-v${{ steps.get_version.outputs.VERSION }}-linux-amd64.tar.gz`

            ---
            **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **æäº¤**: ${{ github.sha }}
          files: |
            artifacts/windows-installer/*.exe
            artifacts/windows-zip/*.zip
            artifacts/macos-dmg/*.dmg
            artifacts/macos-tarball/*.tar.gz
            artifacts/linux-deb/*.deb
            artifacts/linux-rpm/*.rpm
            artifacts/linux-appimage/*.AppImage
            artifacts/linux-tarball/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
