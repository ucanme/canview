# è¾“å…¥æ³•ï¼ˆIMEï¼‰æ”¯æŒé—®é¢˜ä¿®å¤æŒ‡å—

## é—®é¢˜æ¦‚è¿°

ç”¨æˆ·åé¦ˆï¼š"åœ¨ä¿¡å·åº“ç®¡ç†ä¸­å’Œè¾“å…¥æ³•é€‚é…çš„ä¸å¤ªå¥½"

**æ ¹æœ¬åŸå› **ï¼šå½“å‰ä½¿ç”¨ `on_key_down` äº‹ä»¶å¤„ç†æ–‡æœ¬è¾“å…¥ï¼Œæ— æ³•æ­£ç¡®å¤„ç†è¾“å…¥æ³•ï¼ˆIMEï¼‰è¾“å‡ºçš„æ–‡æœ¬ã€‚

---

## å½“å‰å®ç°åˆ†æ

### é—®é¢˜ä»£ç ä½ç½®

1. **src/view/src/library_view.rs**
   - ç¬¬ 251 è¡Œï¼šåº“åè¾“å…¥æ¡†
   - ç¬¬ 1035 è¡Œï¼šç‰ˆæœ¬åè¾“å…¥æ¡†

2. **src/view/src/ui/components/text_input.rs**
   - ç¬¬ 123 è¡Œï¼šTextInput ç»„ä»¶

### æ ¸å¿ƒé—®é¢˜

```rust
// âŒ å½“å‰å®ç°ï¼šä½¿ç”¨ on_key_down
if keystroke.len() == 1 {
    if let Some(ch) = keystroke.chars().next() {
        // åªèƒ½å¤„ç†å•å­—ç¬¦æŒ‰é”®
        // æ— æ³•æ¥æ”¶è¾“å…¥æ³•è¾“å‡ºçš„ä¸­æ–‡æ–‡æœ¬ï¼ˆå¦‚"ä½ å¥½"ï¼‰
    }
}
```

**ä¸ºä»€ä¹ˆè¿™ä¼šå¯¼è‡´é—®é¢˜ï¼Ÿ**

è¾“å…¥æ³•çš„å·¥ä½œæµç¨‹ï¼š
```
ç”¨æˆ·è¾“å…¥ "nihao" â†’ æ˜¾ç¤ºå€™é€‰è¯ â†’ é€‰æ‹© "ä½ å¥½" â†’ on_input("ä½ å¥½")
                                                    â†‘
                                            å½“å‰ä»£ç æ— æ³•æ¥æ”¶è¿™ä¸ªäº‹ä»¶
```

---

## å·²æ”¯æŒçš„åŠŸèƒ½ âœ…

### æ•°æ®å±‚
- âœ… å®Œå…¨æ”¯æŒ UTF-8 å­—ç¬¦
- âœ… æ­£ç¡®å¤„ç†ä¸­æ–‡å­—ç¬¦ï¼ˆ3å­—èŠ‚/å­—ç¬¦ï¼‰
- âœ… å­—ç¬¦çº§å…‰æ ‡ä½ç½®è®¡ç®—
- âœ… æ­£ç¡®æ’å…¥/åˆ é™¤å¤šå­—èŠ‚å­—ç¬¦

### éªŒè¯è§„åˆ™
- **åº“å**ï¼šæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ç©ºæ ¼
  ```rust
  !ch.is_control() && (ch.is_ascii_alphanumeric() || ch == ' ' || !ch.is_ascii())
  ```
  - âœ… "æµ‹è¯•ä¿¡å·åº“"
  - âœ… "Testæµ‹è¯•åº“123"
  - âœ… "ğŸ“Š æ•°æ®åˆ†æåº“"

- **ç‰ˆæœ¬å**ï¼šæ”¯æŒç‰ˆæœ¬å·æ ¼å¼
  ```rust
  ch.is_ascii_alphanumeric() || ch == '.' || ch == '_' || ch == '-'
  ```
  - âœ… "v1.0.0"
  - âœ… "release-2.0"
  - âœ… "v1.2.3-beta"

---

## ä¸æ”¯æŒçš„åŠŸèƒ½ âŒ

### è¾“å…¥æ³•æ”¯æŒ
- âŒ æ— æ³•æ¥æ”¶è¾“å…¥æ³•è¾“å‡ºçš„å¤§éƒ¨åˆ†æ–‡æœ¬
- âŒ æ— æ³•æ˜¾ç¤ºå€™é€‰è¯åˆ—è¡¨
- âŒ æ— æ³•æ˜¾ç¤ºé¢„ç¼–è¾‘çŠ¶æ€ï¼ˆæ‹¼éŸ³/å‡åï¼‰
- âŒ æ— æ³•å¤„ç†è¾“å…¥æ³•çš„ç¡®è®¤/å–æ¶ˆæ“ä½œ

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç ”ç©¶å¹¶ä½¿ç”¨ GPUI çš„æ­£ç¡® APIï¼ˆæ¨èï¼‰

**ç›®æ ‡**ï¼šæ‰¾åˆ° GPUI æä¾›çš„æ–‡æœ¬è¾“å…¥ API

**ç ”ç©¶è·¯å¾„**ï¼š
1. æŸ¥çœ‹ Zed ç¼–è¾‘å™¨çš„æºç ï¼ˆGPUI æ¥æºï¼‰
   - https://github.com/zed-industries/zed
   - æœç´¢ `on_input` æˆ– `TextInput` ç»„ä»¶

2. æ£€æŸ¥ GPUI æ–‡æ¡£å’Œç¤ºä¾‹
   - æŸ¥çœ‹ `crates/gpui/src/` æºç 
   - æœç´¢æ–‡æœ¬è¾“å…¥ç›¸å…³çš„äº‹ä»¶å’Œæ–¹æ³•

3. å‚è€ƒå…¶ä»–ä½¿ç”¨ GPUI çš„é¡¹ç›®

**é¢„æœŸ API**ï¼š
```rust
// âœ… ç†æƒ³çš„å®ç°æ–¹å¼
div()
    .on_key_down(|event, cx| {
        // åªå¤„ç†ç‰¹æ®Šé”®ï¼šEnter, Escape, Backspace, ç®­å¤´ç­‰
        match keystroke.as_str() {
            "enter" => { /* æäº¤ */ }
            "escape" => { /* å–æ¶ˆ */ }
            "backspace" => { /* åˆ é™¤ */ }
            _ => {}
        }
    })
    .on_input(|text: &str, cx| {
        // å¤„ç†æ–‡æœ¬è¾“å…¥ï¼ŒåŒ…æ‹¬è¾“å…¥æ³•è¾“å‡ºçš„æ–‡æœ¬
        // text å¯èƒ½æ˜¯ "ä½ å¥½" è¿™æ ·çš„å¤šå­—ç¬¦å­—ç¬¦ä¸²
        this.input_text = text.to_string();
        cx.notify();
    })
```

**ä¼˜åŠ¿**ï¼š
- å®Œæ•´æ”¯æŒè¾“å…¥æ³•
- ä»£ç æ¸…æ™°ç®€æ´
- è·¨å¹³å°ä¸€è‡´æ€§

---

### æ–¹æ¡ˆ 2ï¼šæ”¹è¿›ç°æœ‰å®ç°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å‚è€ƒ `src/view/src/app/impls.rs` ç¬¬ 616 è¡Œçš„å®ç°ï¼š

```rust
// æ”¹è¿›ï¼šæ”¯æŒå¤šå­—ç¬¦å­—ç¬¦ä¸²æ’å…¥
if key.len() > 0 && !key.to_lowercase().starts_with("backspace")
    && !key.to_lowercase().starts_with("delete")
    && !key.to_lowercase().starts_with("left")
    && !key.to_lowercase().starts_with("right")
    && !key.to_lowercase().starts_with("enter")
    && !key.to_lowercase().starts_with("escape") {
    
    // æ’å…¥æ•´ä¸ª key å­—ç¬¦ä¸²ï¼ˆå¯èƒ½åŒ…å«è¾“å…¥æ³•æ–‡æœ¬ï¼‰
    let pos = this.cursor_position.min(this.input_text.len());
    
    // éªŒè¯æ‰€æœ‰å­—ç¬¦éƒ½æ˜¯å¯æ‰“å°çš„
    if key.chars().all(|c| !c.is_control()) {
        this.input_text.insert_str(pos, &key);
        this.cursor_position = pos + key.chars().count();
        eprintln!("Inserted '{}' at position {}", key, pos);
        cx.notify();
    }
}
```

**ä¼˜ç‚¹**ï¼š
- æ”¯æŒå¤šå­—ç¬¦æ’å…¥
- å¯¹æŸäº›è¾“å…¥æ³•å¯èƒ½æœ‰æ•ˆ
- æ”¹åŠ¨è¾ƒå°

**ç¼ºç‚¹**ï¼š
- ä»ç„¶ä¾èµ– `on_key_down`
- æ— æ³•æ­£ç¡®å¤„ç†é¢„ç¼–è¾‘çŠ¶æ€
- ä¸åŒå¹³å°è¡¨ç°ä¸ä¸€è‡´

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `src/view/src/library_view.rs`ï¼ˆ2å¤„ï¼‰
- `src/view/src/ui/components/text_input.rs`

---

### æ–¹æ¡ˆ 3ï¼šæä¾›æ›¿ä»£è¾“å…¥æ–¹å¼ï¼ˆç”¨æˆ·ä¸´æ—¶æ–¹æ¡ˆï¼‰

åœ¨ä¿®å¤è¾“å…¥æ³•ä¹‹å‰ï¼Œä¸ºç”¨æˆ·æä¾›æ›¿ä»£æ–¹æ¡ˆï¼š

#### é€‰é¡¹ 1ï¼šä½¿ç”¨å‰ªè´´æ¿ç²˜è´´
```
1. åœ¨è®°äº‹æœ¬ä¸­è¾“å…¥ä¸­æ–‡ï¼šæµ‹è¯•ä¿¡å·åº“
2. å¤åˆ¶æ–‡æœ¬ï¼ˆCtrl+Cï¼‰
3. ç²˜è´´åˆ°åº”ç”¨ç¨‹åºï¼ˆCtrl+Vï¼‰
```

#### é€‰é¡¹ 2ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶
```json
{
  "libraries": [
    {
      "id": "library_1",
      "name": "æµ‹è¯•CANä¿¡å·åº“",
      "channel_type": "CAN",
      "versions": []
    }
  ]
}
```

#### é€‰é¡¹ 3ï¼šå…ˆç”¨è‹±æ–‡åæ”¹å
```
1. åˆ›å»ºåº“ï¼šTestLibrary
2. ç¼–è¾‘é…ç½®æ–‡ä»¶å°† name æ”¹ä¸ºï¼šæµ‹è¯•ä¿¡å·åº“
3. é‡æ–°åŠ è½½é…ç½®
```

---

## æµ‹è¯•è®¡åˆ’

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

1. **è¿è¡Œåº”ç”¨ç¨‹åº**
   ```bash
   cargo run --release
   ```

2. **å¯¼èˆªåˆ°åº“ç®¡ç†ç•Œé¢**
   - ç‚¹å‡» "Config" è§†å›¾
   - ç‚¹å‡» "+ New" æŒ‰é’®

3. **æµ‹è¯•ä¸­æ–‡è¾“å…¥**
   ```
   è¾“å…¥æ³•ï¼šå¾®è½¯æ‹¼éŸ³
   è¾“å…¥ï¼šcesexinhao ku
   é€‰æ‹©ï¼šæµ‹è¯•ä¿¡å·åº“
   
   é¢„æœŸç»“æœï¼š
   âœ… æ˜¾ç¤º "æµ‹è¯•ä¿¡å·åº“"
   âŒ æ˜¾ç¤º "cesexinhao ku"ï¼ˆé—®é¢˜ï¼‰
   ```

4. **æµ‹è¯•æ··åˆè¾“å…¥**
   ```
   è¾“å…¥ï¼šCANæµ‹è¯•åº“2024
   
   é¢„æœŸç»“æœï¼š
   âœ… æ˜¾ç¤º "CANæµ‹è¯•åº“2024"
   âœ… å…‰æ ‡ä½ç½®æ­£ç¡®ï¼ˆ10ä¸ªå­—ç¬¦ä½ç½®ï¼‰
   âœ… é€€æ ¼é”®æ­£ç¡®åˆ é™¤ä¸­æ–‡å­—ç¬¦
   ```

5. **æµ‹è¯•ç‰¹æ®Šå­—ç¬¦**
   ```
   ç‰ˆæœ¬åï¼šv1.0.0-beta_release
   
   é¢„æœŸç»“æœï¼š
   âœ… æ­£ç¡®æ˜¾ç¤ºç‰ˆæœ¬å·
   âœ… æ”¯æŒç‚¹ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
   ```

### è‡ªåŠ¨åŒ–æµ‹è¯•

å·²åˆ›å»ºï¼š`tests/test_ime_input.rs`

è¿è¡Œæµ‹è¯•ï¼š
```bash
cargo test -p canview ime_input_tests
```

æµ‹è¯•å†…å®¹ï¼š
- âœ… UTF-8 å­—ç¬¦å¤„ç†
- âœ… å­—ç¬¦ vs å­—èŠ‚é•¿åº¦
- âœ… å…‰æ ‡ä½ç½®è®¡ç®—
- âœ… å¤šå­—èŠ‚å­—ç¬¦æ’å…¥/åˆ é™¤
- âœ… ä¸­æ—¥éŸ©æ–‡å­—ç¬¦æ”¯æŒ

---

## ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰

1. **ç ”ç©¶ GPUI API**
   - æŸ¥çœ‹æºç ï¼š`~/.cargo/git/checkouts/zed-*/crates/gpui/src/`
   - æœç´¢å…³é”®è¯ï¼š`on_input`, `TextInput`, `text_input`
   - æŸ¥çœ‹ Zed ç¼–è¾‘å™¨çš„æ–‡æœ¬è¾“å…¥å®ç°

2. **åˆ›å»ºæ¦‚å¿µéªŒè¯**
   - å®ç°ç®€å•çš„ `on_input` äº‹ä»¶å¤„ç†å™¨
   - æµ‹è¯•æ˜¯å¦èƒ½æ¥æ”¶è¾“å…¥æ³•æ–‡æœ¬

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆçŸ­æœŸï¼‰

1. **æ”¹è¿›ç°æœ‰å®ç°**
   - å°† `library_view.rs` æ”¹ä¸ºæ”¯æŒå¤šå­—ç¬¦æ’å…¥
   - æ›´æ–° `text_input.rs` ç»„ä»¶

2. **æ·»åŠ è°ƒè¯•æ—¥å¿—**
   - è®°å½•æ‰€æœ‰æ¥æ”¶åˆ°çš„æŒ‰é”®äº‹ä»¶
   - è®°å½•è¾“å…¥æ³•ç›¸å…³çš„äº‹ä»¶

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸï¼‰

1. **å¹³å°ç‰¹å®šä¼˜åŒ–**
   - Windows: WM_IME_* æ¶ˆæ¯å¤„ç†
   - macOS: NSTextInputClient åè®®
   - Linux: Text Input Convention

2. **UI æ”¹è¿›**
   - æ˜¾ç¤ºè¾“å…¥æ³•å€™é€‰è¯çª—å£
   - æ˜¾ç¤ºé¢„ç¼–è¾‘æ–‡æœ¬ï¼ˆæ‹¼éŸ³/å‡åï¼‰

---

## å®æ–½æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šç ”ç©¶ APIï¼ˆ1-2 å¤©ï¼‰

```bash
# æŸ¥çœ‹æœ¬åœ° GPUI æºç 
cd ~/.cargo/git/checkouts/zed-*

# æœç´¢æ–‡æœ¬è¾“å…¥ç›¸å…³ä»£ç 
grep -r "on_input" crates/gpui/src/
grep -r "TextInput" crates/gpui/src/
grep -r "composition" crates/gpui/src/  # IME composition
```

**å…³é”®æ–‡ä»¶**ï¼š
- `crates/gpui/src/element.rs` - å…ƒç´ å’Œäº‹ä»¶å¤„ç†
- `crates/gpui/src/window.rs` - çª—å£å’Œè¾“å…¥
- `crates/gpui/src/input.rs` - è¾“å…¥å¤„ç†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

### ç¬¬ 2 æ­¥ï¼šåˆ›å»ºæµ‹è¯•ï¼ˆåŠå¤©ï¼‰

åˆ›å»ºç®€å•çš„æµ‹è¯•æ–‡ä»¶éªŒè¯ APIï¼š
```rust
// tests/test_on_input.rs
div()
    .id("test_input")
    .on_input(|text: &str, cx| {
        println!("Received input: {}", text);
    });
```

### ç¬¬ 3 æ­¥ï¼šå®æ–½ä¿®å¤ï¼ˆ2-3 å¤©ï¼‰

ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š
1. `src/view/src/library_view.rs`
2. `src/view/src/ui/components/text_input.rs`
3. `src/view/src/app/impls.rs`

### ç¬¬ 4 æ­¥ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1-2 å¤©ï¼‰

- æµ‹è¯•ä¸­æ–‡æ‹¼éŸ³è¾“å…¥æ³•
- æµ‹è¯•æ—¥æ–‡è¾“å…¥æ³•
- æµ‹è¯•éŸ©æ–‡è¾“å…¥æ³•
- æµ‹è¯•æ··åˆè¾“å…¥

---

## å‚è€ƒèµ„æº

### GPUI å’Œ Zed
- [Zed Editor GitHub](https://github.com/zed-industries/zed)
- [GPUI æºç ](~/.cargo/git/checkouts/zed-*/crates/gpui/)

### è¾“å…¥æ³•æŠ€æœ¯
- [winit IME Issue](https://github.com/rust-windowing/winit/issues/1363)
- [Unicode in Rust](https://doc.rust-lang.org/std/unicode/)

### é¡¹ç›®æ–‡æ¡£
- `IME_INPUT_SUPPORT.md` - è¯¦ç»†æŠ€æœ¯åˆ†æ
- `INPUT_CHARACTER_SUPPORT.md` - å½“å‰å­—ç¬¦æ”¯æŒæƒ…å†µ
- `TEXTINPUT_TEST.md` - TextInput ç»„ä»¶è¯´æ˜

---

## æŠ€æœ¯è¦ç‚¹

### UTF-8 å­—ç¬¦å¤„ç†

```rust
let text = "æµ‹è¯•åº“";

// âœ… æ­£ç¡®ï¼šå­—ç¬¦çº§åˆ«
let char_count = text.chars().count();  // 3 ä¸ªå­—ç¬¦
let chars: Vec<char> = text.chars().collect();

// âŒ é”™è¯¯ï¼šå­—èŠ‚çº§åˆ«
let byte_count = text.len();  // 9 ä¸ªå­—èŠ‚

// æ’å…¥å­—ç¬¦
let mut chars: Vec<char> = text.chars().collect();
chars.insert(2, 'ä¸­');
let new_text = chars.into_iter().collect();

// åˆ é™¤å­—ç¬¦
let mut chars: Vec<char> = text.chars().collect();
chars.remove(0);  // åˆ é™¤ç¬¬ä¸€ä¸ªå­—ç¬¦
```

### å…‰æ ‡ä½ç½®

```rust
// âœ… æ­£ç¡®ï¼šåŸºäºå­—ç¬¦
let text_len = text.chars().count();
cursor_position = cursor_position.min(text_len);

// âŒ é”™è¯¯ï¼šåŸºäºå­—èŠ‚
let text_len = text.len();  // ä¼šå¾—åˆ°å­—èŠ‚æ•°ï¼Œä¸æ˜¯å­—ç¬¦æ•°
```

### å­—ç¬¦éªŒè¯

```rust
// åº“åéªŒè¯ï¼ˆå®½æ¾ï¼‰
fn is_valid_library_char(ch: char) -> bool {
    !ch.is_control() && (ch.is_ascii_alphanumeric() || ch == ' ' || !ch.is_ascii())
}

// ç‰ˆæœ¬åéªŒè¯ï¼ˆä¸¥æ ¼ï¼‰
fn is_valid_version_char(ch: char) -> bool {
    ch.is_ascii_alphanumeric() || ch == '.' || ch == '_' || ch == '-'
}
```

---

## æˆåŠŸæ ‡å‡†

ä¿®å¤å®Œæˆåï¼Œåº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… ä½¿ç”¨æ‹¼éŸ³è¾“å…¥æ³•è¾“å…¥ä¸­æ–‡
   - è¾“å…¥ "nihao" â†’ æ˜¾ç¤º "ä½ å¥½"
   
2. âœ… ä½¿ç”¨äº”ç¬”è¾“å…¥æ³•è¾“å…¥ä¸­æ–‡
   - è¾“å…¥ "tces" â†’ æ˜¾ç¤º "æµ‹è¯•"

3. âœ… æ··åˆè¾“å…¥ä¸­è‹±æ–‡å’Œæ•°å­—
   - "CANæµ‹è¯•åº“2024" æ­£ç¡®æ˜¾ç¤º

4. âœ… å…‰æ ‡ä½ç½®æ­£ç¡®
   - ç§»åŠ¨å…‰æ ‡æ—¶æŒ‰å­—ç¬¦ç§»åŠ¨ï¼Œä¸æ˜¯å­—èŠ‚

5. âœ… åˆ é™¤æ“ä½œæ­£ç¡®
   - é€€æ ¼é”®åˆ é™¤å®Œæ•´çš„ä¸­æ–‡å­—ç¬¦

6. âœ… è·¨å¹³å°ä¸€è‡´æ€§
   - Windowsã€macOSã€Linux éƒ½èƒ½æ­£å¸¸å·¥ä½œ

---

## æ€»ç»“

**é—®é¢˜**ï¼šä½¿ç”¨ `on_key_down` æ— æ³•å¤„ç†è¾“å…¥æ³•

**åŸå› **ï¼š`on_key_down` åªæ¥æ”¶æŒ‰é”®äº‹ä»¶ï¼Œä¸æ¥æ”¶è¾“å…¥æ³•è¾“å‡º

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ğŸ” ç ”ç©¶ GPUI çš„ `on_input` API
2. ğŸ”§ æ”¹è¿›ç°æœ‰ä»£ç æ”¯æŒå¤šå­—ç¬¦æ’å…¥
3. ğŸ§â€â™‚ï¸ æä¾›ä¸´æ—¶æ›¿ä»£æ–¹æ¡ˆ

**ä¼˜å…ˆçº§**ï¼š
1. é«˜ï¼šç ”ç©¶ API å¹¶åˆ›å»ºæ¦‚å¿µéªŒè¯
2. ä¸­ï¼šæ”¹è¿›ç°æœ‰å®ç°
3. ä½ï¼šå¹³å°ç‰¹å®šä¼˜åŒ–

**é¢„æœŸç»“æœ**ï¼š
æ‰¾åˆ°æ­£ç¡®çš„ API åï¼Œå¯ä»¥è½»æ¾å®ç°å®Œæ•´çš„è¾“å…¥æ³•æ”¯æŒã€‚

---

**æœ€åæ›´æ–°**ï¼š2024
**è´Ÿè´£äºº**ï¼šå¼€å‘å›¢é˜Ÿ
**çŠ¶æ€**ï¼šå¾…ç ”ç©¶ GPUI API